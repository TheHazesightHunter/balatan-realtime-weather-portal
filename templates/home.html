{% extends 'base.html' %}{% block extra_css %}
<!-- Leaflet CSS -->
<link
	rel="stylesheet"
	href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
	integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
	crossorigin=""
/>
{% endblock %} {% block content %}

<!-- Metric Cards Section -->
<section class="py-40">
	<div class="row g-3 g-md-4">
		<!-- Card 1: Highest Alert Level -->
		<div class="col-6 col-xl-3">
			<div
				class="card border-0 shadow-sm h-100 alert-card alert-card--{{ metrics.highest_alert_level }}"
			>
				<div class="card-body d-flex flex-column">
					<h6 class="n-text text-muted mb-3">Highest Alert Level</h6>
					<div
						class="d-flex align-items-center justify-content-between mt-auto"
					>
						<span class="fs-3 fw-bold text-capitalize">
							{{ metrics.alert_level_info.level }}
						</span>
						<span class="fs-2">
							<i
								class="fas {{ metrics.alert_level_info.icon }}"
								style="color: {{ metrics.alert_level_info.color }};"
							></i>
						</span>
					</div>
				</div>
			</div>
		</div>

		<!-- Card 2: Rainfall Forecast -->
		<div class="col-6 col-xl-3">
			<div class="card border-0 shadow-sm h-100">
				<div class="card-body d-flex flex-column">
					<h6 class="n-text text-muted mb-3">Rainfall Forecast</h6>
					<div
						class="d-flex align-items-center justify-content-between mt-auto"
					>
						<span class="fs-3 fw-bold"
							>{{ metrics.rainfall_forecast.level }}</span
						>
						<span class="fs-2">
							<i
								class="fas {{ metrics.rainfall_forecast.icon }}"
								style="color: {{ metrics.rainfall_forecast.color }};"
							></i>
						</span>
					</div>
				</div>
			</div>
		</div>

		<!-- Card 3: Stations Requiring Attention -->
		<div class="col-6 col-xl-3">
			<div class="card border-0 shadow-sm h-100">
				<div class="card-body d-flex flex-column">
					<h6 class="n-text text-muted mb-3">Stations Requiring Attention</h6>
					<div
						class="d-flex align-items-center justify-content-between mt-auto"
					>
						<span class="fs-3 fw-bold">
							{{ metrics.attention_stations|length }}/{{ metrics.total_sensors
							}}
						</span>
						<span class="fs-2">
							{% if metrics.attention_stations|length > 0 %}
							<i class="fas fa-exclamation-triangle text-danger"></i>
							{% else %}
							<i class="fas fa-check-circle text-primary"></i>
							{% endif %}
						</span>
					</div>
				</div>
			</div>
		</div>

		<!-- Card 4: Weather Stations Online -->
		<div class="col-6 col-xl-3">
			<div class="card border-0 shadow-sm h-100">
				<div class="card-body d-flex flex-column">
					<h6 class="n-text text-muted mb-3">Weather Stations Online</h6>
					<div
						class="d-flex align-items-center justify-content-between mt-auto"
					>
						<span class="fs-3 fw-bold">
							{{ metrics.online_sensors }}/{{ metrics.total_sensors }}
						</span>
						<span class="fs-2">
							{% if metrics.online_sensors == metrics.total_sensors %}
							<i class="fas fa-check-circle text-primary"></i>
							{% else %}
							<i class="fas fa-exclamation-circle text-warning"></i>
							{% endif %}
						</span>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>

<!-- Alert Banners -->
{% if metrics.highest_alert_count > 0 %}
<section class="pb-1">
	<div class="container-fluid px-0">
		<div class="row g-2 g-md-3 alert-banners-row mx-0">
			{% if metrics.critical_count > 0 %}
			<div class="col-6 col-lg-auto">
				<div
					class="alert border-0 rounded-pill shadow-sm mb-0 flood-alert flood-alert--critical"
					role="alert"
					aria-live="assertive"
				>
					<div class="d-flex align-items-center gap-2">
						<i
							class="fas fa-exclamation-triangle alert-icon"
							aria-hidden="true"
						></i>
						<div class="alert-content">
							<h6 class="mb-0 fw-semibold text-uppercase">
								FLOOD ALERT - Critical
							</h6>
						</div>
					</div>
				</div>
			</div>
			{% endif %} {% if metrics.warning_count > 0 %}
			<div class="col-6 col-lg-auto">
				<div
					class="alert border-0 rounded-pill shadow-sm mb-0 flood-alert flood-alert--warning"
					role="alert"
					aria-live="polite"
				>
					<div class="d-flex align-items-center gap-2">
						<i
							class="fas fa-exclamation-circle alert-icon"
							aria-hidden="true"
						></i>
						<div class="alert-content">
							<h6 class="mb-0 fw-semibold text-uppercase">
								FLOOD ALERT - Warning
							</h6>
						</div>
					</div>
				</div>
			</div>
			{% endif %} {% if metrics.alert_count > 0 %}
			<div class="col-6 col-lg-auto">
				<div
					class="alert border-0 rounded-pill shadow-sm mb-0 flood-alert flood-alert--alert"
					role="alert"
					aria-live="polite"
				>
					<div class="d-flex align-items-center gap-2">
						<i class="fas fa-bolt alert-icon" aria-hidden="true"></i>
						<div class="alert-content">
							<h6 class="mb-0 fw-semibold text-uppercase">
								FLOOD ALERT - Alert
							</h6>
						</div>
					</div>
				</div>
			</div>
			{% endif %} {% if metrics.advisory_count > 0 %}
			<div class="col-6 col-lg-auto">
				<div
					class="alert border-0 rounded-pill shadow-sm mb-0 flood-alert flood-alert--advisory"
					role="alert"
					aria-live="polite"
				>
					<div class="d-flex align-items-center gap-2">
						<i class="fas fa-info-circle alert-icon" aria-hidden="true"></i>
						<div class="alert-content">
							<h6 class="mb-0 fw-semibold text-uppercase">FLOOD ADVISORY</h6>
						</div>
					</div>
				</div>
			</div>
			{% endif %}
		</div>
	</div>
</section>
{% endif %}

<section>
	<div class="row g-3 g-lg-4">
		<!-- Weather Card Column -->
		<div class="col-12 col-lg-6">
			<div class="weather-card">
				<!-- Header: Title + Station + Time -->
				<div class="weather-card__header mb-24">
					<div class="weather-card__title-block">
						<h4 class="weather-card__title color-white fw-600">
							Current Weather
						</h4>
						<div class="weather-card__station">
							<i class="fas fa-map-marker-alt me-1"></i>
							St4 - MDRRMO Weather Station
						</div>
						<!-- Data timestamp display -->
						<!-- <div class="weather-card__data-time">
							<i
								class="fas fa-database me-1"
								style="font-size: 0.8em; opacity: 0.8"
							></i>
							<span class="weather-card__latest-reading">
								{% if latest and (latest.get('DateTime') or
								latest.get('DateTimeStamp')) %} {% set data_time =
								latest.get('DateTime') or latest.get('DateTimeStamp') %} Data:
								{{ data_time | format_time }} {% else %} No sensor data {% endif
								%}
							</span>
						</div> -->
					</div>
					<!-- <div class="weather-card__time">
						<i class="far fa-clock"></i>
						{{ latest.get('DateTimeStamp') | format_time if latest and
						latest.get('DateTimeStamp') else "09:01 AM" }}
					</div> -->
					<div class="weather-card__data-time">
						<span class="weather-card__latest-reading">
							{% if latest and (latest.get('DateTime') or
							latest.get('DateTimeStamp')) %} {% set data_time =
							latest.get('DateTime') or latest.get('DateTimeStamp') %} Last
							Update : {{ data_time | format_time }} {% else %} No sensor data
							{% endif %}
						</span>
					</div>
				</div>

				<!-- Main Display: Icon + Rainfall Value -->
				<div class="weather-card__main mb-24">
					<div class="weather-card__icon">
						<img
							src="{{ url_for('static', filename='media/forecast-icons/night-no-rain.png') }}"
							alt="Weather condition"
							class="img-fluid"
						/>
					</div>
					<div class="weather-card__precipitation text-center">
						<div class="weather-card__main-value color-white">
							{% if latest and latest.get('HourlyRain') is not none %} {{
							"%.1f"|format(latest.get('HourlyRain')|float) }}<small
								>mm/hr</small
							>
							{% else %} --<small>mm/hr</small>
							{% endif %}
						</div>
						<div class="weather-card__probability color-white">
							<strong>80%</strong> chance of rain today
						</div>
					</div>
				</div>

				<!-- Clean Weather Advisory - Business Logic Moved to Service -->
				<!-- <div class="weather-card__advisory mb-20" id="weather-advisory">
					<div class="weather-card__advisory-content color-white">
						<i
							class="{{ weather_alert.icon }} me-2"
							style="color: {{ weather_alert.color }};"
						></i>
						<span class="fw-600">{{ weather_alert.message }}</span>
					</div>
				</div> -->

				<!-- Metrics Grid -->
				<div class="row g-2">
					<!-- Water Level -->
					<div class="col-6 col-lg-3">
						<div class="weather-card__metric">
							<img
								class="weather-card__metric-icon"
								src="{{ url_for('static', filename='media/icons/water_level.svg') }}"
								alt="Water Level"
							/>
							<div class="weather-card__metric-content">
								<div class="weather-card__metric-label">Water Level</div>
								<div class="weather-card__metric-value">
									{% if latest and latest.get('WaterLevel') is not none %} {{
									"%.1f"|format(latest.get('WaterLevel')|float) }}<span
										class="unit"
										>m</span
									>
									{% else %} --<span class="unit">m</span>
									{% endif %}
								</div>
							</div>
						</div>
					</div>
					<!-- Wind Speed -->
					<div class="col-6 col-lg-3">
						<div class="weather-card__metric">
							<img
								class="weather-card__metric-icon"
								src="{{ url_for('static', filename='media/icons/wind_speed.svg') }}"
								alt="Wind Speed"
							/>
							<div class="weather-card__metric-content">
								<div class="weather-card__metric-label">Wind Speed</div>
								<div class="weather-card__metric-value">
									{% if latest and latest.get('WindSpeed') is not none %} {{
									"%.1f"|format(latest.get('WindSpeed')|float) }}<span
										class="unit"
										>m/s</span
									>
									{% else %} --<span class="unit">m/s</span>
									{% endif %}
								</div>
							</div>
						</div>
					</div>
					<!-- Humidity -->
					<div class="col-6 col-lg-3">
						<div class="weather-card__metric">
							<img
								class="weather-card__metric-icon"
								src="{{ url_for('static', filename='media/icons/humidity.svg') }}"
								alt="Humidity"
							/>
							<div class="weather-card__metric-content">
								<div class="weather-card__metric-label">Humidity</div>
								<div class="weather-card__metric-value">
									{% if latest and latest.get('Humidity') is not none %} {{
									"%.0f"|format(latest.get('Humidity')|float) }}<span
										class="unit"
										>%</span
									>
									{% else %} --<span class="unit">%</span>
									{% endif %}
								</div>
							</div>
						</div>
					</div>
					<!-- Temperature -->
					<div class="col-6 col-lg-3">
						<div class="weather-card__metric">
							<img
								class="weather-card__metric-icon"
								src="{{ url_for('static', filename='media/icons/temperature.svg') }}"
								alt="Temperature"
							/>
							<div class="weather-card__metric-content">
								<div class="weather-card__metric-label">Temperature</div>
								<div class="weather-card__metric-value">
									{% if latest and latest.get('Temperature') is not none %} {{
									"%.1f"|format(latest.get('Temperature')|float) }}<span
										class="unit"
										>°C</span
									>
									{% else %} --<span class="unit">°C</span>
									{% endif %}
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Map Column -->
		<div class="col-12 col-lg-6">
			<div class="map-container">
				<div id="station-map" class="interactive-map">
					<div class="map-loading">
						<div class="spinner-border color-primary" role="status">
							<span class="visually-hidden">Loading map...</span>
						</div>
					</div>
				</div>
				<div class="map-legend-bar">
					<div class="legend-bar-item legend-bar-normal">
						<span>Normal</span>
					</div>
					<div class="legend-bar-item legend-bar-advisory">
						<span>Advisory</span>
					</div>
					<div class="legend-bar-item legend-bar-alert"><span>Alert</span></div>
					<div class="legend-bar-item legend-bar-warning">
						<span>Warning</span>
					</div>
					<div class="legend-bar-item legend-bar-critical">
						<span>Critical</span>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>

<!-- PRECIPITATION CHART -->
<section class="pt-40">
	<div class="chart-container">
		<button
			type="button"
			class="chart-nav-arrow chart-nav-arrow--left"
			id="btn-prev-day"
			aria-label="View previous day"
		>
			<i class="fas fa-chevron-left" aria-hidden="true"></i>
		</button>

		<div class="chart-wrapper">
			<div class="chart-header">
				<h5 class="chart-title precipitation-title">
					<i class="fas fa-cloud-rain chart-title__icon" aria-hidden="true"></i>
					Hourly Precipitation Monitoring
				</h5>

				<div class="chart-controls">
					<div class="date-picker-inline">
						<i class="fas fa-calendar-alt" aria-hidden="true"></i>
						<label for="datePicker" class="sr-only">Select date</label>
						<span class="date-picker-label" aria-hidden="true"
							>Select Date:</span
						>
						<input
							type="date"
							id="datePicker"
							class="date-picker-inline__input"
							aria-label="Select specific date for precipitation data"
						/>
					</div>

					<button
						type="button"
						id="btn-export-csv"
						class="export-btn-inline"
						aria-label="Export precipitation data to CSV file"
					>
						<i class="fas fa-download" aria-hidden="true"></i>
						<span class="export-btn-text">Export CSV</span>
					</button>
				</div>
			</div>

			<div
				class="chart-loading hidden"
				id="chart-loading"
				role="status"
				aria-live="polite"
			>
				<div class="chart-loading__spinner" aria-hidden="true"></div>
				<p class="chart-loading__text">Loading precipitation data...</p>
			</div>

			<div
				id="precipitationChart"
				class="chart-canvas"
				role="img"
				aria-label="Precipitation chart showing 24-hour monitoring data"
			></div>

			<div class="chart-error" id="chart-error" role="alert">
				<i
					class="fas fa-exclamation-triangle chart-error__icon"
					aria-hidden="true"
				></i>
				<h3 class="chart-error__title">Unable to Load Data</h3>
				<p class="chart-error__message">Error loading precipitation data.</p>
				<button type="button" class="chart-error__btn" data-action="retry">
					<i class="fas fa-redo" aria-hidden="true"></i>
					Retry
				</button>
			</div>
		</div>

		<button
			type="button"
			class="chart-nav-arrow chart-nav-arrow--right"
			id="btn-next-day"
			aria-label="View next day"
		>
			<i class="fas fa-chevron-right" aria-hidden="true"></i>
		</button>
	</div>
</section>

<!-- WATER LEVEL CHART -->
<section class="pt-40">
	<div class="chart-container">
		<button
			type="button"
			class="chart-nav-arrow chart-nav-arrow--left"
			id="btn-water-prev-day"
			aria-label="View previous day"
		>
			<i class="fas fa-chevron-left" aria-hidden="true"></i>
		</button>

		<div class="chart-wrapper">
			<div class="chart-header">
				<h5 class="chart-title water-level-title">
					<i class="fas fa-water chart-title__icon" aria-hidden="true"></i>
					Hourly Water Level Monitoring
				</h5>

				<div class="chart-controls">
					<div class="date-picker-inline">
						<i class="fas fa-calendar-alt" aria-hidden="true"></i>
						<label for="waterDatePicker" class="sr-only">Select date</label>
						<span class="date-picker-label" aria-hidden="true"
							>Select Date:</span
						>
						<input
							type="date"
							id="waterDatePicker"
							class="date-picker-inline__input"
							aria-label="Select specific date for water level data"
						/>
					</div>

					<button
						type="button"
						id="btn-export-water-csv"
						class="export-btn-inline"
						aria-label="Export water level data to CSV file"
					>
						<i class="fas fa-download" aria-hidden="true"></i>
						<span class="export-btn-text">Export CSV</span>
					</button>
				</div>
			</div>

			<div
				class="chart-loading hidden"
				id="water-chart-loading"
				role="status"
				aria-live="polite"
			>
				<div class="chart-loading__spinner" aria-hidden="true"></div>
				<p class="chart-loading__text">Loading water level data...</p>
			</div>

			<div
				id="waterLevelChart"
				class="chart-canvas"
				role="img"
				aria-label="Water level chart showing 24-hour monitoring data"
			></div>

			<div class="chart-error" id="water-chart-error" role="alert">
				<i
					class="fas fa-exclamation-triangle chart-error__icon"
					aria-hidden="true"
				></i>
				<h3 class="chart-error__title">Unable to Load Data</h3>
				<p class="chart-error__message">Error loading water level data.</p>
				<button type="button" class="chart-error__btn" data-action="retry">
					<i class="fas fa-redo" aria-hidden="true"></i>
					Retry
				</button>
			</div>
		</div>

		<button
			type="button"
			class="chart-nav-arrow chart-nav-arrow--right"
			id="btn-water-next-day"
			aria-label="View next day"
		>
			<i class="fas fa-chevron-right" aria-hidden="true"></i>
		</button>
	</div>
</section>

{% endblock %} {% block extra_js %}
<!-- External Libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

<!-- Weather Data -->
<script>
	const weatherData = {{ weather | tojson | safe }};

	// CONFIG INJECTION: Complete config from config.py for map.js
	window.APP_CONFIG = {
		stations: {{ sites | tojson | safe }},
		thresholds: {{ thresholds | tojson | safe }},
		stationColors: {{ station_colors | tojson | safe }},
		alertColors: {
			normal: "#409ac7",
			advisory: "#3b82f6",
			alert: "#eab308",
			warning: "#f97316",
			critical: "#dc2626"
		}
	};

	console.log('[CONFIG] Injected from config.py:', window.APP_CONFIG);
</script>

<script src="{{ url_for('static', filename='js/weather-card-realtime.js') }}"></script>
<script src="{{ url_for('static', filename='js/alert-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/map.js') }}"></script>

<!-- Load station configuration from config.py -->
<script>
	async function loadStationConfigFromAPI() {
		try {
			console.log("Loading station configuration from config.py...");

			let response = await fetch("/api/config/stations");
			let data = await response.json();

			if (data.success && data.stations) {
				console.log("Config loaded from /api/config/stations");
				const stationConfig = {};

				data.stations.forEach((station) => {
					stationConfig[station.id] = {
						name: station.name,
						color: station.color || "#409ac7",
					};
				});

				return stationConfig;
			}

			response = await fetch("/api/config/complete");
			data = await response.json();

			if (data.success) {
				console.log("Config loaded from /api/config/complete");
				const stationConfig = {};

				if (data.sites && Array.isArray(data.sites)) {
					data.sites.forEach((site) => {
						stationConfig[site.id] = {
							name: site.name,
							color: site.color || "#409ac7",
						};
					});
				}

				return stationConfig;
			}

			throw new Error("No valid configuration found in API response");
		} catch (error) {
			console.warn("Could not load config from API:", error.message);
			console.log("Using fallback configuration with all 5 stations...");

			return {
				St1: { name: "Binudegahan Station", color: "#409ac7" },
				St2: { name: "Mang-it Station", color: "#8b5cf6" },
				St3: { name: "Laganac Station", color: "#ec4899" },
				St4: { name: "MDRRMO Weather Station", color: "#6366f1" },
				St5: { name: "Luluasan Station", color: "#06b6d4" },
			};
		}
	}

	window.configLoader = {
		load: loadStationConfigFromAPI,
		getStationConfigObject: async () => {
			if (!window._stationConfig) {
				window._stationConfig = await loadStationConfigFromAPI();
			}
			return window._stationConfig;
		},
	};

	window.CSVExporter =
		window.CSVExporter ||
		class {
			exportPrecipitationData(data, dateStr) {
				console.log("Exporting precipitation data:", data);
				alert(
					"CSV export functionality needs to be connected to your CSV exporter script."
				);
			}
			exportWaterLevelData(data, dateStr) {
				console.log("Exporting water level data:", data);
				alert(
					"CSV export functionality needs to be connected to your CSV exporter script."
				);
			}
		};
</script>

<script src="{{ url_for('static', filename='js/csv-exporter.js') }}"></script>
<script src="{{ url_for('static', filename='js/precipitation-chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/water-level-chart.js') }}"></script>

<!-- Chart initialization with synchronization -->
<script>
	document.addEventListener("DOMContentLoaded", async () => {
		console.log("Starting chart initialization with synchronization...");

		const today = new Date().toISOString().split("T")[0];
		const precipPicker = document.getElementById("datePicker");
		const waterPicker = document.getElementById("waterDatePicker");

		if (precipPicker) precipPicker.value = today;
		if (waterPicker) waterPicker.value = today;

		try {
			console.log("Loading station configuration from config.py...");
			const stationConfig = await window.configLoader.getStationConfigObject();
			console.log("Station config loaded:", stationConfig);

			Object.entries(stationConfig).forEach(([id, config]) => {
				console.log(`${id}: ${config.name} (${config.color})`);
			});

			const csvExporter = new CSVExporter();
			let precipChart = null;
			let waterChart = null;

			if (document.getElementById("precipitationChart")) {
				console.log("Initializing precipitation chart...");
				precipChart = new PrecipitationChart({
					chartId: "precipitationChart",
					apiEndpoint: "/api/precipitation-data",
					autoLoad: true,
					stationConfig,
					onDataLoaded: (data) => {
						console.log("Precipitation data loaded:", data);
						if (precipPicker && data.date) precipPicker.value = data.date;
					},
				});
				await precipChart.init();
			}

			if (document.getElementById("waterLevelChart")) {
				console.log("Initializing water level chart...");
				waterChart = new WaterLevelChart({
					chartId: "waterLevelChart",
					apiEndpoint: "/api/water-level-data",
					autoLoad: true,
					stationConfig,
					onDataLoaded: (data) => {
						console.log("Water level data loaded:", data);
						if (waterPicker && data.date) waterPicker.value = data.date;
					},
					onThresholdBreach: (alert) => {
						console.warn("FLOOD ALERT:", alert);
					},
				});
				await waterChart.init();
			}

			console.log("Setting up chart synchronization...");

			// Precipitation Previous Day Button - WITH SYNC
			document.getElementById("btn-prev-day")?.addEventListener("click", () => {
				const currentDate = precipPicker?.value;
				if (currentDate && precipChart) {
					const date = new Date(currentDate);
					date.setDate(date.getDate() - 1);
					const newDate = date.toISOString().split("T")[0];
					precipPicker.value = newDate;
					precipChart.loadSpecificDate(newDate);

					if (waterPicker && waterChart) {
						waterPicker.value = newDate;
						waterChart.loadSpecificDate(newDate);
					}
					console.log("Synced both charts to:", newDate);
				}
			});

			// Precipitation Next Day Button - WITH SYNC
			document.getElementById("btn-next-day")?.addEventListener("click", () => {
				const currentDate = precipPicker?.value;
				if (currentDate && precipChart) {
					const date = new Date(currentDate);
					date.setDate(date.getDate() + 1);
					const newDate = date.toISOString().split("T")[0];
					precipPicker.value = newDate;
					precipChart.loadSpecificDate(newDate);

					if (waterPicker && waterChart) {
						waterPicker.value = newDate;
						waterChart.loadSpecificDate(newDate);
					}
					console.log("Synced both charts to:", newDate);
				}
			});

			// Water Level Previous Day Button - WITH SYNC
			document
				.getElementById("btn-water-prev-day")
				?.addEventListener("click", () => {
					const currentDate = waterPicker?.value;
					if (currentDate && waterChart) {
						const date = new Date(currentDate);
						date.setDate(date.getDate() - 1);
						const newDate = date.toISOString().split("T")[0];
						waterPicker.value = newDate;
						waterChart.loadSpecificDate(newDate);

						if (precipPicker && precipChart) {
							precipPicker.value = newDate;
							precipChart.loadSpecificDate(newDate);
						}
						console.log("Synced both charts to:", newDate);
					}
				});

			// Water Level Next Day Button - WITH SYNC
			document
				.getElementById("btn-water-next-day")
				?.addEventListener("click", () => {
					const currentDate = waterPicker?.value;
					if (currentDate && waterChart) {
						const date = new Date(currentDate);
						date.setDate(date.getDate() + 1);
						const newDate = date.toISOString().split("T")[0];
						waterPicker.value = newDate;
						waterChart.loadSpecificDate(newDate);

						if (precipPicker && precipChart) {
							precipPicker.value = newDate;
							precipChart.loadSpecificDate(newDate);
						}
						console.log("Synced both charts to:", newDate);
					}
				});

			// Precipitation Date Picker - WITH SYNC
			precipPicker?.addEventListener("change", (e) => {
				if (e.target.value && precipChart) {
					precipChart.loadSpecificDate(e.target.value);
					if (waterPicker && waterChart) {
						waterPicker.value = e.target.value;
						waterChart.loadSpecificDate(e.target.value);
					}
					console.log("Synced both charts to:", e.target.value);
				}
			});

			// Water Level Date Picker - WITH SYNC
			waterPicker?.addEventListener("change", (e) => {
				if (e.target.value && waterChart) {
					waterChart.loadSpecificDate(e.target.value);
					if (precipPicker && precipChart) {
						precipPicker.value = e.target.value;
						precipChart.loadSpecificDate(e.target.value);
					}
					console.log("Synced both charts to:", e.target.value);
				}
			});

			// Export Button Handlers
			document
				.getElementById("btn-export-csv")
				?.addEventListener("click", () => {
					if (precipChart && precipChart.chartData) {
						csvExporter.exportPrecipitationData(
							precipChart.chartData,
							precipPicker?.value
						);
					} else {
						alert("No precipitation data available to export");
					}
				});

			document
				.getElementById("btn-export-water-csv")
				?.addEventListener("click", () => {
					if (waterChart && waterChart.chartData) {
						csvExporter.exportWaterLevelData(
							waterChart.chartData,
							waterPicker?.value
						);
					} else {
						alert("No water level data available to export");
					}
				});

			console.log("Chart initialization complete with synchronization!");
			console.log("Both charts will now sync automatically when dates change!");

			// Debug access
			window.debugCharts = {
				precipitation: precipChart,
				waterLevel: waterChart,
				stationConfig: stationConfig,
				testSync: () => {
					console.log("Testing sync...");
					const testDate = "2024-12-01";
					if (precipPicker) precipPicker.value = testDate;
					if (waterPicker) waterPicker.value = testDate;
					if (precipChart) precipChart.loadSpecificDate(testDate);
					if (waterChart) waterChart.loadSpecificDate(testDate);
					console.log("Both charts set to:", testDate);
				},
				testAPI: async () => {
					try {
						const response = await fetch("/api/precipitation-data");
						const data = await response.json();
						console.log("API Test:", data);
					} catch (error) {
						console.error("API Test failed:", error);
					}
				},
			};
		} catch (error) {
			console.error("Chart initialization failed:", error);
			alert("Failed to initialize charts: " + error.message);
		}
	});
</script>

{% endblock %}
